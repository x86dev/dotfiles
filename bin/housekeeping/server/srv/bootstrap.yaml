#
# docker-compose pull
# docker-compose up -d [--no-deps] [<service>]
#

version: '2.2'

services:
  
  nginx-letsencrypt:
    image: jrcs/letsencrypt-nginx-proxy-companion
    container_name: nginx-letsencrypt
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    volumes_from:
      - "nginx-proxy"

  nginx-proxy:
    image: jwilder/nginx-proxy:alpine
    container_name: nginx-proxy
    labels:
      - com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ${MY_SRV_ROOT}/nginx-proxy/etc/vhost.d:/etc/nginx/vhost.d
      - ${MY_SRV_ROOT}/nginx-proxy/html:/usr/share/nginx/html
      - ${MY_SRV_ROOT}/letsencrypt/certs:/etc/nginx/certs
      - /var/run/docker.sock:/tmp/docker.sock:ro

  ttrss-data:
    image: nornagon/postgres
    container_name: ttrss-data
    restart: always

  ttrss:
    image: x86dev/docker-ttrss
    container_name: ttrss
    restart: always
    links:
      - ttrss-data:db
    environment:
      - UID=1000
      - GID=1000
      - TTRSS_URL=ttrss.${MY_DOMAIN}
      - TTRSS_PROTO=https
      - TTRSS_SELF_URL=https://ttrss.${MY_DOMAIN}
      - LETSENCRYPT_HOST=ttrss.${MY_DOMAIN}
      - LETSENCRYPT_EMAIL=webmaster@${MY_DOMAIN}
      - VIRTUAL_HOST=ttrss.${MY_DOMAIN}
      - VIRTUAL_PORT=8080

  nextcloud:
    image: wonderfall/nextcloud
    container_name: nextcloud
    restart: always
    links:
      - nextcloud-data:db_nextcloud
    expose:
      - "8080"
    environment:
      - UID=1000
      - GID=1000
      - UPLOAD_MAX_SIZE=10G
      - APC_SHM_SIZE=128M
      - OPCACHE_MEM_SIZE=128
      - CRON_PERIOD=15m
      - TZ=Berlin/UTC
      - DB_TYPE=mysql
      - DB_NAME=nextcloud
      - DB_USER=${MY_NEXTCLOUD_DB_USER}
      - DB_PASSWORD=${MY_NEXTCLOUD_DB_PASSWORD}
      - DB_HOST=db_nextcloud
      - VIRTUAL_HOST=nextcloud.${MY_DOMAIN}
      - VIRTUAL_PORT=8080
      - LETSENCRYPT_HOST=nextcloud.${MY_DOMAIN}
      - LETSENCRYPT_EMAIL=webmaster@${MY_DOMAIN}
      - DOMAIN=localhost
    volumes:
      - ${MY_SRV_ROOT}/nextcloud/data:/data
      - ${MY_SRV_ROOT}/nextcloud/config:/config
      - ${MY_SRV_ROOT}/nextcloud/apps:/apps2

  nextcloud-data:
    image: mariadb:10
    container_name: nextcloud_db
    restart: always
    volumes:
      - ${MY_SRV_ROOT}/nextcloud/db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MY_MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=${MY_NEXTCLOUD_DB_USER}
      - MYSQL_PASSWORD=${MY_NEXTCLOUD_DB_PASSWORD}

  ipsec-vpn-server:
    image: hwdsl2/ipsec-vpn-server
    container_name: ipsec-vpn-server
    restart: always
    privileged: true
    environment:
      - VPN_IPSEC_PSK=${MY_VPN_IPSEC_PSK}
      - VPN_USER=${MY_VPN_USER}
      - VPN_PASSWORD=${MY_VPN_PASSWORD}
    ports:
      - "500:500/udp"
      - "4500:4500/udp"
    volumes:
      - /lib/modules:/lib/modules:ro

  gitlab:
    image: 'gitlab/gitlab-ce:latest'
    container_name: gitlab
    restart: always
    hostname: 'gitlab.${MY_DOMAIN}'
    environment:
      - VIRTUAL_HOST=gitlab.${MY_DOMAIN}
      - VIRTUAL_PORT=8081
    ports:
      - '8081:80'
      - '4444:443'
      - '2222:22'
    volumes:
      - ${MY_SRV_ROOT}/gitlab/config:/etc/gitlab
      - ${MY_SRV_ROOT}/gitlab/logs:/var/log/gitlab
      - ${MY_SRV_ROOT}/gitlab/data:/var/opt/gitlab
